# 02.03 比賽記錄 (Match Record)

## 1. 概述

本文件詳細描述 VolleyBro 系統的比賽記錄功能需求，涵蓋新建比賽記錄、設定比賽規則、記錄得失分、球員表現、球員替換、比賽事件等功能。這些功能旨在為記錄者提供一個直觀、易用的比賽記錄平台，確保比賽數據的準確性與即時性，並支援管理者與隊員在比賽期間的有效協作。

---

## 2. 功能需求列表

### 3.0.0 創建比賽紀錄

#### FR-3.0.0.0 創建比賽紀錄

- **功能 ID**: FR-3.0.0.0
- **標題**: 創建比賽紀錄
- **描述**: 管理者可創建比賽紀錄，包括設定基本資訊與比賽規則。
- **詳細說明**:

  - 比賽表單要求輸入對手名稱、比賽日期、地點和比賽類型（例如 MEN、WOMEN、MIXED）。
  - 規則設定表單包含 `setCount`（總局數，例如 3 或 5）和 `decidingSetPoints`（決勝局得分，例如 15 或 25）。
  - 系統驗證輸入值是否符合比賽類型（如國際排球規則）。
  - 系統自動生成唯一的比賽 ID。
  - 創建成功後，系統儲存完整比賽設定並導向比賽詳情頁面以進行後續記錄。

- **流程圖**:

  ```mermaid
  graph TD
    A[管理者進入創建比賽頁面] --> B[輸入對手、日期、地點和類型]
    B --> C{驗證基本資料}
    C -->|有效| D[自動生成比賽 ID]
    C -->|無效| E[顯示錯誤訊息]
    D --> F[進入比賽規則設定]
    F --> G[輸入 setCount 和 decidingSetPoints]
    G --> H{驗證規則資料}
    H -->|有效| I[儲存完整比賽設定]
    H -->|無效| J[顯示錯誤訊息]
    I --> K[導向比賽詳情頁面]
  ```

- **驗收標準**:

  - 比賽創建表單能正確驗證所有輸入資料（基本資訊和規則設定）。
  - 創建後自動生成比賽 ID 並成功應用設定的規則。
  - 完成後成功導向比賽詳情頁面。

- **測試案例**:

  ```gherkin
  Feature: 創建比賽紀錄
    Scenario: 管理者創建完整比賽紀錄
      Given 管理者已登入
      When 管理者進入創建比賽頁面
      And 管理者輸入對手 "Team B"，日期 "2025-04-02"，地點 "Stadium A"，類型 "MEN"
      And 管理者提交基本資訊表單
      Then 系統驗證資料並生成比賽 ID
      And 系統顯示比賽規則設定表單
      When 管理者輸入 setCount "5" 和 decidingSetPoints "15"
      And 管理者提交規則設定表單
      Then 系統儲存完整比賽設定
      And 管理者被導向比賽詳情頁面
  ```

---

### 3.1.0 逐球紀錄 (Ball-by-Ball Record)

#### FR-3.1.0.0 逐球紀錄

- **功能 ID**: FR-3.1.0.0
- **標題**: 逐球紀錄
- **描述**: 記錄者可進行完整的逐球紀錄，包括得失分與球員技術表現統計。
- **詳細說明**:

  - 記錄流程以單一球為單位，整合得分記錄與技術表現：
    1. 選擇我方參與該球的球員
    2. 選擇得分方（本隊或對手）
    3. 選擇技術類型（SERVING、ATTACK等）與結果（成功或失誤）
    4. 選擇對方相應的技術表現（若適用）
  - 系統即時更新當前局數比分並顯示於頁面
  - 同時更新相關球員的技術統計數據
  - 在一局結束時，系統自動判斷勝負並切換至下一局
  - 記錄後儲存完整球紀錄歷史以供後續查看或編輯

- **流程圖**:

  ```mermaid
  graph TD
    A[記錄者進入比賽紀錄頁面] --> B[選擇我方參與球員]
    B --> D[選擇我方得分或失分類型]
    D --> E[選擇對方相應得失分類型]
    E --> F[系統記錄完整球資訊]
    F --> G[即時更新比分]
    G --> H[更新球員和隊伍技術統計]
    H --> I{檢查是否結束一局}
    I -->|是| J[判斷勝負並切換下一局]
    I -->|否| K[儲存球紀錄歷史]
    J --> K
  ```

- **驗收標準**:

  - 逐球紀錄介面能正確整合得分與技術表現記錄流程
  - 記錄後系統能即時更新比分與球員技術統計
  - 系統能自動判斷一局結束並切換至下一局
  - 球紀錄歷史正確儲存並可供查看

- **測試案例**:

  ```gherkin
  Feature: 逐球紀錄功能
    Scenario: 記錄發球得分並更新技術統計
      Given 記錄者已登入並進入逐球紀錄頁面
      And 當前比分為本隊 20，對手 18
      When 記錄者選擇我方球員 "John Doe"
      And 記錄者選擇技術類型 "SERVING" 且結果為成功
      And 記錄者選擇對方接發失誤
      Then 系統更新比分為本隊 21，對手 18
      And 系統更新球員 "John Doe" 的發球成功次數
      And 系統儲存此球完整記錄
      
    Scenario: 記錄攻擊失分並結束一局
      Given 記錄者已登入並進入逐球紀錄頁面
      And 當前比分為本隊 20，對手 24
      When 記錄者選擇我方球員 "Jane Smith"
      And 記錄者選擇技術類型 "ATTACK" 且結果為失誤
      And 記錄者選擇對方攔網成功
      Then 系統更新比分為本隊 20，對手 25
      And 系統更新球員 "Jane Smith" 的攻擊失誤次數
      And 系統儲存此球完整記錄
      And 系統判斷對手勝出並切換至下一局
  ```

---

### 3.2.0 記錄球員替換

#### FR-3.2.0.0 記錄球員替換

- **功能 ID**: FR-3.2.0.0
- **標題**: 記錄球員替換
- **描述**: 記錄者可記錄球員替換情況並追蹤次數。
- **詳細說明**:

  - 替換介面記錄進場（in）與離場（out）球員及替換紀錄 (entry) ID。
  - 系統驗證替換合法性（例如，替換次數未超限、只能替換回原位）。
  - 記錄後儲存替換歷史並更新球員上場時間與次數統計。

- **流程圖**:

  ```mermaid
  graph TD
    A[記錄者進入比賽記錄頁面] --> B[選擇先發球員]
    B --> C[點選替補按鈕]
    C --> D[選擇替補球員]
    D --> E[確認替換]
    E --> F{驗證替換合法性}
    F -->|有效| G[記錄替換]
    F -->|無效| H[顯示錯誤訊息]
    G --> I[更新上場時間與次數]
    I --> J[儲存替換歷史]
  ```

- **驗收標準**:

  - 替換介面能正確記錄替換並驗證合法性。
  - 替換歷史與上場統計正確更新並儲存。

- **測試案例**:

  ```gherkin
  Feature: 記錄球員替換
    Scenario: 記錄者記錄球員替換
      Given 記錄者已登入並進入比賽記錄頁面
      When 記錄者選擇進場球員 "John Doe" 和點選替補按鈕
      And 記錄者選擇替補球員 "Jane Doe"
      And 替換次數未超限
      Then 系統記錄替換並更新上場統計
      And 系統記錄進出場的紀錄 ID
      And 系統儲存替換歷史
  ```

---

### 3.3.0 記錄比賽事件

#### FR-3.3.0.0 記錄比賽事件

- **功能 ID**: FR-3.3.0.0
- **標題**: 記錄比賽事件
- **描述**: 記錄者可記錄比賽中的特殊事件，例如暫停或挑戰。
- **詳細說明**:

  - 事件類型包含 `timeout`（暫停）、`challenge`（挑戰）等。
  - 記錄事件發生時間與相關細節（例如，哪方請求）。
  - 記錄後儲存事件歷史以供查看或編輯。

- **流程圖**:

  ```mermaid
  graph TD
    A[記錄者進入比賽記錄頁面] --> B[選擇事件類型和細節]
    B --> C[記錄事件]
    C --> D[儲存事件歷史]
  ```

- **驗收標準**:

  - 事件記錄介面能正確記錄事件及其細節。
  - 事件歷史正確儲存並可查看。

- **測試案例**:

  ```gherkin
  Feature: 記錄比賽事件
    Scenario: 記錄者記錄暫停事件
      Given 記錄者已登入並進入比賽記錄頁面
      When 記錄者選擇事件類型 "timeout" 並記錄紀錄 ID
      And 記錄者提交事件
      Then 系統儲存事件歷史並顯示成功訊息
  ```

---

## 3. 資料模型關聯

比賽記錄模組涉及以下資料模型：

- **Match**: 儲存比賽基本資訊（對手、日期、地點、類型、規則等）。
- **Score**: 儲存比賽的得分歷史（得分方、時間戳、局數等）。
- **PlayerStats**: 儲存球員技術統計（發球、攻擊等的成功與失誤次數）。
- **Substitution**: 儲存球員替換歷史（進場/離場球員、時間、次數等）。
- **Event**: 儲存比賽事件歷史（事件類型、時間、細節等）。

---

## 4. 技術需求

- **身份驗證**:
  - 使用 Auth.js 實現角色權限控制，確保僅管理者與記錄者可操作比賽記錄功能。
- **資料安全**:
  - 比賽資料與統計數據加密儲存，防止未授權存取。
  - 敏感操作（如編輯得分或替換）需二次驗證。
- **效能**:
  - 比賽資訊與記錄頁面載入時間不超過 500ms。
  - 得分、替換與事件記錄操作完成時間不超過 2 秒。
