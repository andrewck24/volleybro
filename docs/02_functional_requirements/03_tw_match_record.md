# 02.03 賽事紀錄 (Match Record)

## 1. 概述

本文件詳細描述 VolleyBro 系統的賽事紀錄功能需求，涵蓋新建賽事紀錄、設定比賽規則、記錄得失分、球員表現、球員替換、比賽事件等功能。這些功能旨在為記錄者提供一個直觀、易用的賽事紀錄平台，確保比賽數據的準確性與即時性，並支援管理者與成員在比賽期間的有效協作。

---

## 2. 功能需求列表

### 3.0.0 創建賽事紀錄 (Create Match Record)

#### FR-3.0.0.0 創建賽事紀錄

- **功能 ID**: FR-3.0.0.0
- **標題**: 創建賽事紀錄
- **描述**: 管理者可創建賽事紀錄，包括設定基本資訊與比賽規則。
- **詳細說明**:

  - 比賽表單要求輸入雙方隊伍名稱、比賽日期、地點和比賽類型（例如 MEN、WOMEN、MIXED）。
  - 規則設定表單包含 `setCount`（總局數，例如 3 或 5）和 `decidingSetPoints`（決勝局得分，例如 15 或 25）。
  - 系統儲存賽事資訊並自動生成唯一的比賽 ID。
  - 創建成功後，系統儲存完整比賽設定並導向比賽詳情頁面以進行後續記錄。

- **流程圖**:

  ```mermaid
  graph TD
    A[管理者點選創建賽事紀錄按鈕] --> B[打開創建賽事紀錄視窗]
    B --> C[輸入賽事資訊與規則]
    C --> D[確認出賽陣容]
    D --> E[點選創建賽事紀錄按鈕]
    E --> F[系統儲存賽事紀錄並生成賽事紀錄 ID]
    F --> G[導向賽事紀錄詳情頁面]
  ```

- **相關元件**:

  - `ActionButton`: 用於開啟創建賽事紀錄表單的按鈕。
  - `NewRecordForm`: 用於顯示創建賽事紀錄的表單。

- **驗收標準**:

  - 系統能夠接受並驗證所有必填的賽事基本資訊（對手名稱、比賽日期、地點和比賽類型）
  - 系統能夠接受並驗證規則設定（總局數和決勝局得分）
  - 成功創建後自動生成唯一的比賽 ID
  - 系統能夠正確儲存出賽陣容資訊
  - 系統完整儲存所有賽事設定資訊
  - 創建完成後自動導向至賽事紀錄詳情頁面
  - 導向的詳情頁面能夠正確顯示剛才創建的賽事資訊

- **Version Changes**:
  - **v0.8.0**: 使用 `Dialog` 重構創建賽事紀錄頁面。
  - **v0.2.0**: 首次加入 `創建賽事紀錄` 功能。

### 3.0.1 賽事紀錄總覽 (Record Overview)

#### 3.0.1.0 查看賽事紀錄總覽 (View Record Overview)

- **功能 ID**: FR-3.0.1.0
- **標題**: 查看賽事紀錄總覽
- **描述**: 管理者可查看賽事紀錄總覽，包括比賽狀態、比分、球員表現等。
- **詳細說明**:

  - 總覽頁面顯示當前比賽狀態（進行中、結束等）。
  - 顯示即時比分與局數。
  - 顯示雙方隊伍技術統計數據（如發球成功率、攻擊成功率等）。
  - 可以在此處切換至新增新的一局或結束比賽的頁面。
  - 可以在此處進入編輯賽事資訊的頁面。

- **流程圖**:

  ```mermaid
  graph TD
    A[隊伍成員點選創建賽事紀錄] --> C[點選賽事紀錄總覽]
    B[隊伍成員點選過去賽事紀錄] --> C
    C --> D[顯示賽事紀錄總覽]
    D --> E{選擇操作}
    E -->|新增一局| F[導向新增局頁面]
    E -->|結束比賽| G[導向結束比賽頁面]
    E -->|編輯賽事資訊| H[導向編輯賽事資訊頁面]
  ```

- **相關元件**:

  - `Match`: 用於顯示賽事紀錄總覽的元件。
  - `StatsItem`: 用於顯示技術統計數據的元件。

- **驗收標準**:
  - 總覽頁面能正確顯示當前比賽狀態、比分與局數
  - 系統能正確顯示雙方隊伍技術統計數據
  - 系統能正確導向新增各局紀錄的頁面
  - 系統能正確導向編輯賽事資訊的頁面

- **Version Changes**:
  - **v0.8.0**: 首次加入 `賽事紀錄總覽` 功能。

---

### 3.1.0 逐球紀錄 (Ball-by-Ball Record)

#### FR-3.1.0.0 逐球紀錄

- **功能 ID**: FR-3.1.0.0
- **標題**: 逐球紀錄
- **描述**: 記錄者可進行完整的逐球紀錄，包括得失分與球員技術表現統計。
- **詳細說明**:

  - 記錄流程以單一球為單位，整合得分記錄與技術表現：
    1. 選擇我方參與該球的球員
    2. 選擇得分方（本隊或對手）
    3. 選擇技術類型（SERVING、ATTACK 等）與結果（成功或失誤）
    4. 選擇對方相應的技術表現（若適用）
  - 系統即時更新當前局數比分並顯示於頁面
  - 同時更新相關球員的技術統計數據
  - 檢視該局是否結束：
    - 更新是否為 set point、該局是否結束的狀態
    - 該局結束時：
      1. 系統自動判斷該局勝負
      2. 根據各局勝負資訊判斷比賽是否結束與比賽勝負
  - 記錄後儲存完整球紀錄歷史以供後續查看或編輯

- **流程圖**:

  ```mermaid
  graph TD
    A[記錄者進入逐球紀錄介面] --> B[選擇我方參與該球的球員]
    B --> C[選擇我方得分或失分類型]
    C --> E[選擇對方得分或失分類型]
    E --> F[系統儲存該筆逐球紀錄]
    F --> G[即時更新比分]
    G --> H[更新球隊與球員技術統計數據]
    H --> I{檢查是否達到局末點}
    I -->|是| J[更新set point狀態]
    I -->|否| L[儲存賽事紀錄]
    J --> K{檢查是否結束一局}
    K -->|是| M[系統判斷該局勝負]
    K -->|否| L
    M --> N{檢查比賽是否結束}
    N -->|是| O[判斷比賽勝負]
    N -->|否| P[切換為局間狀態]
    O --> L
    P --> L
  ```

- **驗收標準**:

  - 逐球紀錄介面能讓記錄者按照流程選擇參與球員、得分方、技術類型與結果
  - 系統能即時更新當前局數比分並顯示於頁面
  - 球員技術統計數據（如攻擊成功/失誤、發球成功/失誤等）能正確更新
  - 系統能正確判斷 set point 狀態與局末點
  - 一局結束時，系統能自動判斷該局勝負
  - 比賽結束時，系統能正確判斷比賽勝負
  - 所有逐球紀錄歷史能完整儲存並可供事後查看或編輯

- **測試案例**:

  ```gherkin
  Feature: 逐球紀錄功能
    Scenario: 記錄發球得分並更新技術統計
      Given 記錄者已登入並進入逐球紀錄頁面
      And 當前比分為本隊 20，對手 18
      When 記錄者選擇我方球員 "John Doe"
      And 記錄者選擇技術類型 "SERVING" 且結果為成功
      And 記錄者選擇對方接發失誤
      Then 系統更新比分為本隊 21，對手 18
      And 系統更新球員 "John Doe" 的發球成功次數
      And 系統儲存此球完整記錄

    Scenario: 記錄攻擊失分並結束一局
      Given 記錄者已登入並進入逐球紀錄頁面
      And 當前比分為本隊 20，對手 24
      When 記錄者選擇我方球員 "Jane Smith"
      And 記錄者選擇技術類型 "ATTACK" 且結果為失誤
      And 記錄者選擇對方攔網成功
      Then 系統更新比分為本隊 20，對手 25
      And 系統更新球員 "Jane Smith" 的攻擊失誤次數
      And 系統儲存此球完整記錄
      And 系統判斷對手勝出並切換至下一局
  ```

---

### 3.2.0 記錄球員替換

#### FR-3.2.0.0 記錄球員替換

- **功能 ID**: FR-3.2.0.0
- **標題**: 記錄球員替換
- **描述**: 記錄者可記錄球員替換情況並追蹤次數。
- **詳細說明**:

  - 替換介面記錄進場（in）與離場（out）球員及替換紀錄 (entry) ID。
  - 系統驗證替換合法性（例如，替換次數未超限、只能替換回原位）。
  - 記錄後儲存替換歷史並更新球員上場時間與次數統計。

- **流程圖**:

  ```mermaid
  graph TD
    A[記錄者進入賽事紀錄頁面] --> B[選擇先發球員]
    B --> C[點選替補按鈕]
    C --> D[選擇替補球員]
    D --> E[確認替換]
    E --> F{驗證替換合法性}
    F -->|有效| G[記錄替換]
    F -->|無效| H[顯示錯誤訊息]
    G --> I[更新上場時間與次數]
    I --> J[儲存替換歷史]
  ```

- **驗收標準**:

  - 替換介面能正確記錄替換並驗證合法性。
  - 替換歷史與上場統計正確更新並儲存。

- **測試案例**:

  ```gherkin
  Feature: 記錄球員替換
    Scenario: 記錄者記錄球員替換
      Given 記錄者已登入並進入賽事紀錄頁面
      When 記錄者選擇進場球員 "John Doe" 和點選替補按鈕
      And 記錄者選擇替補球員 "Jane Doe"
      And 替換次數未超限
      Then 系統記錄替換並更新上場統計
      And 系統記錄進出場的紀錄 ID
      And 系統儲存替換歷史
  ```

---

### 3.3.0 記錄比賽事件

#### FR-3.3.0.0 記錄比賽事件

- **功能 ID**: FR-3.3.0.0
- **標題**: 記錄比賽事件
- **描述**: 記錄者可記錄比賽中的特殊事件，例如暫停或挑戰。
- **詳細說明**:

  - 事件類型包含 `timeout`（暫停）、`challenge`（挑戰）等。
  - 記錄事件發生時間與相關細節（例如，哪方請求）。
  - 記錄後儲存事件歷史以供查看或編輯。

- **流程圖**:

  ```mermaid
  graph TD
    A[記錄者進入賽事紀錄頁面] --> B[選擇事件類型和細節]
    B --> C[記錄事件]
    C --> D[儲存事件歷史]
  ```

- **驗收標準**:

  - 事件記錄介面能正確記錄事件及其細節。
  - 事件歷史正確儲存並可查看。

- **測試案例**:

  ```gherkin
  Feature: 記錄比賽事件
    Scenario: 記錄者記錄暫停事件
      Given 記錄者已登入並進入賽事紀錄頁面
      When 記錄者選擇事件類型 "timeout" 並記錄紀錄 ID
      And 記錄者提交事件
      Then 系統儲存事件歷史並顯示成功訊息
  ```

---

## 3. 資料模型關聯

賽事紀錄模組涉及以下資料模型：

- **Match**: 儲存比賽基本資訊（對手、日期、地點、類型、規則等）。
- **Score**: 儲存比賽的得分歷史（得分方、時間戳、局數等）。
- **PlayerStats**: 儲存球員技術統計（發球、攻擊等的成功與失誤次數）。
- **Substitution**: 儲存球員替換歷史（進場/離場球員、時間、次數等）。
- **Event**: 儲存比賽事件歷史（事件類型、時間、細節等）。

---

## 4. 技術需求

- **身份驗證**:
  - 使用 Auth.js 實現角色權限控制，確保僅管理者與記錄者可操作賽事紀錄功能。
- **資料安全**:
  - 比賽資料與統計數據加密儲存，防止未授權存取。
  - 敏感操作（如編輯得分或替換）需二次驗證。
- **效能**:
  - 賽事資訊與記錄頁面載入時間不超過 500ms。
  - 得分、替換與事件記錄操作完成時間不超過 2 秒。
